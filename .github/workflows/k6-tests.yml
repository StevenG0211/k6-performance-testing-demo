# GitHub Actions workflow for k6 tests using Grafana Cloud k6
# Uses official Grafana k6 actions for simplified CI/CD integration
# k6 runs TypeScript files directly (no build step required)
# Docs: https://grafana.com/whats-new/integrate-grafana-cloud-k6-into-your-cicd-pipeline-with-new-k6-github-actions/
name: k6 Test Suite

on:
  push:
    branches:
      - main
      - ci-sample-workflow-only
  pull_request:

env:
  K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}
  K6_CLOUD_PROJECT_ID: ${{ secrets.K6_CLOUD_PROJECT_ID }}

jobs:
  api-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run API tests
        uses: grafana/run-k6-action@v1
        with:
          path: src/tests/api/basic-api.test.ts
          cloud-run-locally: true
          cloud-comment-on-pr: true

  scenario-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - src/scenarios/load.test.ts
          - src/scenarios/stress.test.ts
          - src/scenarios/spike.test.ts
          - src/scenarios/soak.test.ts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run scenario test
        uses: grafana/run-k6-action@v1
        with:
          path: ${{ matrix.scenario }}
          cloud-run-locally: true
          cloud-comment-on-pr: true
