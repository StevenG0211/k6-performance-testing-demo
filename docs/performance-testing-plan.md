# Performance Testing Project Blueprint

## Purpose

This document guides a performance-testing agent (with deep expertise in Grafana k6 and TypeScript/JavaScript) through recreating a local-first k6 project similar to the `k6-demo` repository. The agent may leverage a browser-based assistant to research current k6 best practices as needed.

## Environment & Tooling Prerequisites

- Node.js (16 or later) and npm.
- Grafana k6 CLI (v1.3.0 or later) installed locally.
- Docker Desktop (or compatible runtime) to host the local `httpbin` target service.
- `xk6-browser` enabled k6 build for browser scenarios.
- Optional: GitHub Actions runner (Linux) for the sample CI workflow.

## Directory & File Layout

Use the project structure outlined in `README.md`:

```
k6-demo/
├── src/
│   ├── tests/
│   │   ├── api/
│   │   └── browser/
│   ├── scenarios/
│   ├── utils/
│   ├── types/
│   └── config/
├── dist/
├── reports/
├── docs/
├── package.json
├── tsconfig.json
├── webpack.config.js
└── README.md
```

- `src/config/test-options.ts`: single source of truth for k6 `Options` definitions (default, load, stress, spike, soak, smoke).
- `src/tests/` & `src/scenarios/`: test entry points and scenario bundles aligned with each performance objective.
- `src/utils/reporting.ts`: exposes `generateHtmlReport` for producing timestamped HTML summaries saved to `reports/`.
- `dist/`: webpack output regenerated on every build (`npm run build`).
- `reports/`: HTML artifacts generated by post-run summaries.

## NPM Scripts & Build Lifecycle

Defined in `package.json`:

- `build`: Webpack compilation (TypeScript → k6-compatible JS) producing fresh `dist/` bundle(s).
- `clean`: Remove `dist/` and `reports/` directories.
- `prepare:reports`: Ensure `reports/` exists before execution.
- `test:*` scripts (`api`, `browser`, `load`, `stress`, `spike`, `soak`): run `clean → prepare:reports → build → k6 run dist/<bundle>.js` sequentially with `--continue-on-error` to guarantee report generation even when thresholds fail.
- `open:report`: Convenience command to open most recent HTML report.
- `lint`, `lint:fix`, `format`, `format:check`: Uphold TypeScript quality (ESLint + Prettier).

Agents must run `npm run build` (or the `test:*` scripts) prior to invoking k6 directly to ensure `dist/` is current.

## Test Types & Execution Considerations

1. **API Baseline (`src/tests/api/basic-api.test.ts`)**
   - Uses `defaultOptions` with staged VUs.
   - Interacts with local httpbin `/get` and `/post` endpoints via `src/utils/http-client.ts`.
   - Command: `npm run test:api` (or `k6 run dist/api.bundle.js` post-build).

2. **Browser Smoke (`src/tests/browser/basic-browser.test.ts`)**
   - Requires `xk6-browser`; uses Chromium via `browser` API.
   - Thin assertions validating document structure.
   - Command: `npm run test:browser` (ensure `K6_BROWSER_HEADLESS=true` in CI contexts).

3. **Load Scenario (`src/scenarios/load.test.ts`)**
   - Imports `loadTestOptions` for moderate, sustained traffic.
   - Command: `npm run test:load`.

4. **Stress Scenario (`src/scenarios/stress.test.ts`)**
   - Exercises aggressive ramp stages from `stressTestOptions`.
   - Command: `npm run test:stress`.

5. **Spike Scenario (`src/scenarios/spike.test.ts`)**
   - Sudden burst defined in `spikeTestOptions`.
   - Command: `npm run test:spike`.

6. **Soak Scenario (`src/scenarios/soak.test.ts`)**
   - Long duration to surface stability concerns using `soakTestOptions`.
   - Command: `npm run test:soak`.

All scenarios depend on an active Dockerized httpbin service (`docker run -d -p 80:80 --name httpbin kennethreitz/httpbin`). Expose `BASE_URL` via `.env` or environment variables when needed.

## Sequential Execution Flow

To execute the entire suite locally:

```bash
npm run test:api
npm run test:browser
npm run test:load
npm run test:stress
npm run test:spike
npm run test:soak
```

Each script rebuilds the bundles and regenerates `reports/`. Reports are named `report-<slug>-executed-<timestamp>.html` as defined in `src/utils/reporting.ts`.

## Reporting & Artifacts

- HTML produced by `generateHtmlReport()` (handleSummary hook) with metrics, thresholds, checks, and metadata.
- Reports stored under `reports/`; accessible via `npm run open:report`.
- Textual console summaries provided by `generateTextSummary()`.
- Optional `.github/workflows/k6-tests.yml` demonstrates artifact upload after each run (scoped to dummy branch `ci-sample-workflow-only`).

## TypeScript, Linting, and Build Quality

- `tsconfig.json` configures compilation targets suitable for k6 (ES2015 modules disabled via webpack).
- Use `npm run lint` / `npm run lint:fix` (ESLint) and `npm run format` / `npm run format:check` (Prettier) to maintain code style.
- Webpack bundles (`npm run build`) must run before invoking k6; output placed under `dist/` and should be regenerated for every change.

## Configuration Hub (`src/config/test-options.ts`)

- Central repository of k6 `Options` objects.
- Modify thresholds, VU stages, and durations here to propagate across scenarios.
- Includes: `defaultOptions`, `smokeTestOptions`, `loadTestOptions`, `stressTestOptions`, `spikeTestOptions`, `soakTestOptions`.

## Agent Guidance & Best Practices

- The agent should consult official k6 documentation for evolving best practices (particularly around thresholds, checks, and browser support).
- Validate Docker connectivity and `BASE_URL` before running scripts to avoid threshold failures caused by connection errors.
- Maintain modular POM-style utilities (`src/utils/`) to encourage reuse and separation of concerns.
- Ensure reports are reviewed after each run for anomalies (threshold breaches, check failures).
- Optional CI: reuse the sample workflow as a starting point, adjusting branch triggers and dependencies as required.

## Deliverables Checklist

- [ ] Project structure as listed above.
- [ ] Docker-based httpbin test target.
- [ ] TypeScript sources compiled with webpack to `dist/`.
- [ ] ESLint & Prettier checks available via npm scripts.
- [ ] k6 scenarios for API, browser, load, stress, spike, and soak tests referencing `src/config/test-options.ts`.
- [ ] HTML reporting via `src/utils/reporting.ts` with timestamped filenames stored in `reports/`.
- [ ] Documented execution commands for sequential local runs.
- [ ] Optional GitHub Actions sample configured for artifact uploads (dummy branch trigger).

